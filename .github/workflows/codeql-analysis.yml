name: "CodeQL - Analyze (C++/CMake + Python)"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 0'  # weekly (UTC) â€” adjust as needed
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  codeql:
    name: Analyze with CodeQL (C++, Python)
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: phlex-src
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp, python, actions
          config-file: phlex-src/.github/codeql/codeql-config.yml
          build-mode: none

      - name: Build & Test inside container
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/workspace \
            -w /workspace \
            ghcr.io/framework-r-d/phlex-ci:latest \
            bash -c '
              set -euo pipefail
              . /workspace/phlex-src/ci/entrypoint.sh
              cmake --preset default -GNinja -S /workspace/phlex-src -B /workspace/phlex-build
              cmake --build /workspace/phlex-build
              cd /workspace/phlex-build
              ctest -j $(nproc) || true
              if [ -f /workspace/phlex-src/build/compile_commands.json ]; then
                cp /workspace/phlex-src/build/compile_commands.json /workspace/compile_commands.json;
              elif [ -f /workspace/phlex-build/compile_commands.json ]; then
                cp /workspace/phlex-build/compile_commands.json /workspace/compile_commands.json;
              fi
            '

      - name: List workspace (debug)
        run: ls -la "$GITHUB_WORKSPACE" || true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "CodeQL"
          output: codeql-results.sarif
