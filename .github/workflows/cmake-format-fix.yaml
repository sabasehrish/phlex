name: CMake Format Fix
run-name: '${{ github.actor }} fixing CMake format'

on:
  issue_comment:
    types:
      - created

permissions:
  pull-requests: write
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    name: Check for phlexbot token
    if: ${{ github.event.issue.pull_request }}

    outputs:
      match_result: ${{ steps.check_comment.outputs.match_result }}
      ref_name: ${{ steps.check_comment.outputs.ref_name }}
      repo_name: ${{ steps.check_comment.outputs.repo_name }}

    steps:
      - id: check_comment
        name: Check comment
        run: |
          match_result=$(echo "$COMMENT_BODY" | grep -qE '^@phlexbot[[:space:]]+format\b' && echo match || echo non_match)
          echo match_result="$match_result" >> $GITHUB_OUTPUT

          ISSUE_NUMBER=${{ github.event.issue.number }}
          REPO="${{ github.repository }}"
          gh api "repos/$REPO/pulls/$ISSUE_NUMBER" > pr.json
          echo "ref_name=$(jq -r .head.ref pr.json)" >> $GITHUB_OUTPUT
          echo "repo_name=$(jq -r .head.repo.full_name pr.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENT_BODY: ${{ github.event.comment.body }}

  apply_cmake_formatting:
    runs-on: ubuntu-latest
    name: Apply CMake formatting
    needs: check
    if: ${{ needs.check.outputs.match_result == 'match' && (github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: phlex-src
          ref: ${{ needs.check.outputs.ref_name }}
          repository: ${{ needs.check.outputs.repo_name }}

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: '3.x'

      - name: Install cmake-format
        run: pip install cmakelang

      - name: Apply CMake formatting
        run: |
          cd phlex-src
          echo "Applying CMake formatting..."
          
          # Find all CMake files
          cmake_files=$(find . -type f \( -name "CMakeLists.txt" -o -name "CMakeLists.txt.in" -o -name "*.cmake" -o -name "*.cmake.in" \) ! -path "*/build/*" ! -path "*/_deps/*")
          
          if [ -z "$cmake_files" ]; then
            echo "No CMake files found to format"
            exit 0
          fi
          
          # Format each file
          for file in $cmake_files; do
            echo "Formatting $file..."
            cmake-format -i "$file"
          done

      - name: Commit formatting changes
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
        id: add_and_commit
        with:
          cwd: phlex-src
          author_name: "github-actions[bot]"
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
          message: 'Apply cmake-format changes'

      - name: Formatting changes committed and pushed
        if: ${{ steps.add_and_commit.outputs.committed == 'true' && steps.add_and_commit.outputs.pushed == 'true'}}
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          message: |
            CMake formatting changes pushed (commit ${{ steps.add_and_commit.outputs.commit_sha }})

      - name: No formatting changes to make
        if: ${{ steps.add_and_commit.outputs.committed == 'false' }}
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          message: |
            No CMake formatting changes to make
