name: CMake Build and Test
run-name: "${{ github.actor }} building and testing Phlex"

on:
  pull_request:
    branches: [ main, develop ]
  issue_comment:
    types: [created]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  BUILD_TYPE: Release

jobs:
  pre-check:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        (github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER') &&
        startsWith(github.event.comment.body, '@phlexbot build')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      is_act: ${{ steps.detect_act.outputs.is_act }}
      pr_details: ${{ steps.pr.outputs.result }}

    steps:
      - name: Get PR details for comment trigger
        if: github.event_name == 'issue_comment'
        id: pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              ref: pr.data.head.ref,
              sha: pr.data.head.sha,
              base_sha: pr.data.base.sha
            };

      - name: Detect act environment
        id: detect_act
        uses: Framework-R-D/phlex/.github/actions/detect-act-env@main

  detect-changes:
    needs: pre-check
    if: >
      needs.pre-check.result == 'success' &&
      github.event_name != 'workflow_dispatch' &&
      needs.pre-check.outputs.is_act != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}

    steps:
      - name: Check out source code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          path: phlex-src

      - name: Detect C++ and CMake changes
        id: filter
        uses: Framework-R-D/phlex/.github/actions/detect-relevant-changes@main
        with:
          repo-path: phlex-src
          base-ref: ${{ github.event_name == 'issue_comment' && fromJSON(needs.pre-check.outputs.pr_details).base_sha || github.event.pull_request.base.sha || github.event.before }}
          head-ref: ${{ github.event_name == 'issue_comment' && fromJSON(needs.pre-check.outputs.pr_details).sha || github.event.pull_request.head.sha || github.sha }}
          file-type: |
            cpp
            cmake

      - name: Report detection outcome
        run: |
          if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
            echo "::notice::No C++ or CMake changes detected; build will be skipped."
          else
            echo "::group::C++ and CMake relevant files"
            printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
            echo "::endgroup::"
          fi

  build:
    needs: [pre-check, detect-changes]
    if: >
      needs.pre-check.result == 'success' &&
      (
        github.event_name == 'workflow_dispatch' ||
        needs.pre-check.outputs.is_act == 'true' ||
        (needs.detect-changes.result == 'success' && needs.detect-changes.outputs.has_changes == 'true')
      ) &&
      (
        github.event_name != 'issue_comment' ||
        github.event.comment.author_association == 'COLLABORATOR' ||
        github.event.comment.author_association == 'OWNER'
      )
    runs-on: ubuntu-24.04

    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest

    steps:
    - name: Check out code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        path: phlex-src
        ref: ${{ github.event_name == 'issue_comment' && fromJSON(needs.build-pre-check.outputs.pr_details).sha || github.ref }}

    - name: Setup build environment
      uses: Framework-R-D/phlex/.github/actions/setup-build-env@main

    - name: Configure CMake
      uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
      with:
        build-type: ${{ env.BUILD_TYPE }}

    - name: Build
      uses: Framework-R-D/phlex/.github/actions/build-cmake@main

    - name: Test
      run: |
        . /entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        ctest -j $(nproc)

  cmake-build-skipped:
    needs: [pre-check, detect-changes]
    if: >
      needs.pre-check.result == 'success' &&
      github.event_name != 'workflow_dispatch' &&
      needs.pre-check.outputs.is_act != 'true' &&
      needs.detect-changes.result == 'success' &&
      needs.detect-changes.outputs.has_changes != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: No relevant C++ or CMake changes detected
      run: echo "::notice::No relevant C++ or CMake changes detected; build skipped."
